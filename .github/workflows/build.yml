name: Build

on:
  # push: # uncomment for act github workflow testing
  workflow_run:
    #workflows: ["Python CI"] # comment-out for act github workflow testing
    #types: # comment-out for act github workflow testing
    #  - completed # comment-out for act github workflow testing

jobs:
  build-doc:
    #if: ${{ github.event.workflow_run.conclusion == 'success' }} # comment-out for act github workflow testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Set up Python & uv
      - name: Setup Python & uv
        uses: ./.github/actions/python-setup
        with:
          python-version: "3.11"

      # Cache pip dependencies (Sphinx and other docs requirements)
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('docs/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Install sphinx dependencies
      - name: Install sphinx dependencies
        run: |
          uv pip install -r docs/requirements.txt

      # Build the documentation
      - name: Build documentation
        run: |
          uv run sphinx-build -b html docs docs/docsite

  build-ansible-collection:
    #if: ${{ github.event.workflow_run.conclusion == 'success' }} # comment-out for act github workflow testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Set up Python & uv
      - name: Setup Python & uv
        uses: ./.github/actions/python-setup
        with:
          python-version: "3.11"

      # Cache pip dependencies (for ansible-related dependencies)
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Build ansible collection
      - name: Build ansible collection
        run: |
          uv run ansible-galaxy collection build

  build-changelog:
    #if: ${{ github.event.workflow_run.conclusion == 'success' }} # comment-out for act github workflow testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Set up Python & uv
      - name: Setup Python & uv
        uses: ./.github/actions/python-setup
        with:
          python-version: "3.11"

      # Configure git identity for commit
      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Bump version and create/update changelog using Commitizen
      - name: Bump version & create/update changelog
        run: uv run cz bump --yes --changelog

      # Push changes and tags
      - name: Push changes and tags
        run: git push origin HEAD --follow-tags
