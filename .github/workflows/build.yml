name: Build

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_run:
    workflows: ["Python CI"]   # only CI, avoid including release to prevent loops
    types:
      - completed

jobs:
  build-doc:
    runs-on: ubuntu-latest
    if: >
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.base.ref == 'main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.workflow_name == 'Python CI')

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python & uv
      - name: Setup Python & uv
        uses: ./.github/actions/python-setup

      # 3. Cache pip dependencies (docs)
      - name: Cache pip dependencies (docs)
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-docs-cache
          restore-keys: pip-docs-cache

      # 4. Install Sphinx dependencies
      - name: Install Sphinx dependencies
        run: uv pip install -r build_docsite/requirements.txt

      # 5. Build documentation
      - name: Build documentation
        run: uv run sphinx-build -b html build_docsite docs/docsite

      # 6. Upload documentation artifact
      - name: Upload documentation artifact
        if: ${{ env.ACT != 'true' }}  # Skip this step in local Act runs
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: docs/docsite

  build-ansible-collection:
    runs-on: ubuntu-latest
    needs: build-doc
    if: >
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.base.ref == 'main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.workflow_name == 'Python CI')

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python & uv
      - name: Setup Python & uv
        uses: ./.github/actions/python-setup

      # 3. Download documentation artifact
      - name: Download documentation artifact
        if: ${{ env.ACT != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: docs
          path: docs/docsite

      # 4. Cache pip dependencies (ansible)
      - name: Cache pip dependencies (ansible)
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-ansible-cache
          restore-keys: pip-ansible-cache

      # 5. Build Ansible collection
      - name: Build Ansible collection
        run: uv run ansible-galaxy collection build
