name: Build

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_run:
    workflows: ["release"]
    types:
      - completed

jobs:
  build-doc:
    runs-on: ubuntu-latest
    if: >
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.base.ref == 'main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.workflow_name == 'Python CI')
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Python & uv
      - name: Setup Python & uv
        uses: ./.github/actions/python-setup

      # Cache pip dependencies for docs
      - name: Cache pip dependencies (docs)
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-docs-cache
          restore-keys: pip-docs-cache

      # Install Sphinx dependencies
      - name: Install Sphinx dependencies
        run: uv run pip install -r build_docsite/requirements.txt

      # Build documentation
      - name: Build documentation
        run: uv run sphinx-build -b html build_docsite docs/docsite

      # Upload documentation artifact
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: docs/docsite

  build-ansible-collection:
    runs-on: ubuntu-latest
    needs: build-doc
    if: >
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.base.ref == 'main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.workflow_name == 'Python CI')
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Python & uv
      - name: Setup Python & uv
        uses: ./.github/actions/python-setup

      # Download documentation artifact
      - name: Download documentation artifact
        uses: actions/download-artifact@v4
        with:
          name: docs
          path: docs/docsite

      # Cache pip dependencies for ansible
      - name: Cache pip dependencies (ansible)
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-ansible-cache
          restore-keys: pip-ansible-cache

      # Build Ansible collection
      - name: Build Ansible collection
        run: uv run ansible-galaxy collection build

      # Upload Ansible collection artifact
      - name: Upload Ansible collection artifact
        uses: actions/upload-artifact@v4
        with:
          name: ansible-collection-${{ needs.build-doc.outputs.tag }}  # if you pass a tag
          path: "jewdba-eda-*.tar.gz"
